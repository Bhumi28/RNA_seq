#!/bin/bash

# generates scripts to uncompress and concatenate Illumina .fastq sequences
# queue these scripts up on Blacklight with "prep.PBS"
#
# Scott Fay - 28 Aug 2013
# updated 4 Apr 2014

#####
# Set directory names
#####

# set the input directory
# this directory contains _all_ of the fastq files generated by the sequencing facility, moved out of their respective folders
in_dir=${SCRATCH}/directory/with/all/.fastq

# make diretory for temporary scripts 
mkdir -p ${SCRATCH}/temp_scripts

# set script directory and filename prefix, and an index for naming scripts
script=${SCRATCH}/temp_scripts/replace_me_prep_

# remove any pre-existing "Dicosmo_prep_" scripts
rm ${script}*
i=0

#####
# Generate scripts
# If everything above is set properly, don't mess with this part
#####

# iterate over unique file prefixes in input directory
for file_prefix in $(ls $in_dir | grep '.fastq.gz' | sed 's/\(.*_R\).*/\1/' | sort -u)
do
    left_read_prefix=${in_dir}/${file_prefix}1

# initialize the new script

    echo writing new script: ${script}${i}
    echo 'to process files with prefix:'
    echo $left_read_prefix
    new_script=${script}${i}
    touch ${new_script}
    (( i++ ))
    echo

#####
# write the script
#####
    echo '#!/bin/bash' >> ${new_script}
    echo >> ${new_script}
    echo left_read_prefix=${left_read_prefix} >> ${new_script}
    echo >> ${new_script}
# uncompress the files
    echo 'for left_reads in ${left_read_prefix}*' >> ${new_script}
    echo 'do' >> ${new_script}
	echo 'right_reads=${left_reads/R1/R2}' >> ${new_script}
	echo 'gunzip $left_reads' >> ${new_script}
	echo 'gunzip $right_reads' >> ${new_script}
    echo 'done' >> ${new_script}
    echo >> ${new_script}
# initialize output files
    echo 'left_out=${left_read_prefix}.fastq' >> ${new_script}
    echo 'touch $left_out' >> ${new_script}
    echo 'right_out=${left_read_prefix/R1/R2}.fastq' >> ${new_script}
    echo 'touch $right_out' >> ${new_script}
    echo >> ${new_script}
# concatenate reads
    echo 'for left_reads in ${left_read_prefix}_0*.fastq' >> ${new_script}
    echo 'do' >> ${new_script}
    echo 'cat $left_reads >> $left_out' >> ${new_script}
    echo 'cat ${left_reads/R1/R2} >> $right_out' >> ${new_script}
    echo 'done' >> ${new_script}
done

# make the scripts executable
chmod 755 ${script}*
